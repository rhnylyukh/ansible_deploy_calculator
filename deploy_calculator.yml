---

- name: Create an instance for calculator
  hosts: localhost
  connection: local
  vars:
      project_id: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30626237656638306333386366313436303839626361646131633732376366656131636264386433
          3932623763376461366633393034326262343865316334660a303238663631383965636330313238
          62386138306163353233313338613364653832353639373630663861666431323435363663613662
          3330383561653366320a326561633263636566363231326464376333366134656339653165326337
          34613566636233303165313131373364616366313437653464633739353030356435
      service_account_email: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30396631316232313832373836343734623065656539656136666436636438383564303836323635
          3765616162373330643261663161366235326464623930650a336235653865633263353164666635
          30376232613939623533636335373132616530363838376334323530656566383132373866633563
          6435626532653235380a306135366161303863333035313664623138343237616439356165643130
          63653839633538396566346332616439313831356438383130663062343233323563623939313637
          37666662383731366364313238333630303539353563366136656262343537373730623637306366
          383839343535323463346332313863666633
      credentials_file: "/opt/ansible/striped-micron-229407-018bd8c4bff7.json"
      zone: "us-west1-b"

  tasks:

    - name: create a instance
      gce:
        state: present
        name: prod-calculator
        machine_type: n1-standard-2
        image: ubuntu-1604
        tags:
          - http-server
        zone: "{{ zone }}"
        project_id: "{{ project_id }}"
        service_account_email: "{{ service_account_email }}"
        credentials_file: "{{ credentials_file }}"
        disk_size: 15

    - name: wait for a couple of minutes
      pause:
        minutes: 1


- name: install all pre-requirements for calculator
  hosts: prod-calculator
  become: yes

  roles:
  - curl
  - nodejs
  - git
  - nginx
  - pm2
  - install_calculator
