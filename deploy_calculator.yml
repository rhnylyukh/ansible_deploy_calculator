---

- name: Create an instance for calculator
  hosts: localhost
  connection: local
  vars:
      project_id: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39363463333337656235666161306562303332616264386638363863306466383666643365656633
          3131343932316131353139313862336131643361363035360a646365333035316632623766326531
          65656238623838653836656134326266393764363561303566333163303331346262646437353735
          3734376262646335390a353630326462343766353165333366616338643930656165623332373761
          34396530306261393431346631363635393633313561613430303164373836336636
      service_account_email: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36306261653564303631383036313338396335626365363532346536326566336431636337366232
          3665323933373161666536643536343630326531613338350a626430376165633064653536313337
          37626138393563363636376534363061393539383834626265663234346234663463393637373834
          3431353235316435640a623966613638396663353863636333613936396435393230383938643066
          34393235313862323937616163373365643937646535663664633533333631313430623761653263
          31616564316266393564313636336434663530353833613761376537313834653338313863303231
          633666626339353838316464316133383763
      credentials_file: "/opt/ansible/striped-micron-229407-018bd8c4bff7.json"
      zone: "us-west1-b"

  tasks:

    - name: create a instance
      gce:
        state: present
        name: prod-calculator
        machine_type: n1-standard-2
        image: ubuntu-1604
        tags:
          - http-server
        zone: "{{ zone }}"
        project_id: "{{ project_id }}"
        service_account_email: "{{ service_account_email }}"
        credentials_file: "{{ credentials_file }}"
        disk_size: 15

    - name: wait for a couple of minutes
      pause:
        minutes: 1


- name: install all pre-requirements for calculator
  hosts: prod-calculator
  become: yes

  roles:
  - curl
  - nodejs
  - git
  - nginx
  - pm2
  - install_calculator
